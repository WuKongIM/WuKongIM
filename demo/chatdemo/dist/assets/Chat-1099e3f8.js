var ye=Object.defineProperty;var Se=(l,n,s)=>n in l?ye(l,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[n]=s;var j=(l,n,s)=>(Se(l,typeof n!="symbol"?n+"":n,s),s);import{d as P,r as m,o as le,W as c,a as ie,b as _,c as M,F as V,e as ue,C as de,f as Ie,g as G,h as A,n as $e,i as z,t as S,j as e,u as w,k as X,l as E,A as U,_ as O,M as we,m as te,p as De,q as se,s as K,w as ne,v as ae,x as ke,y as Te,T as be,z as J,B as oe,S as Le,D as Ee,E as Y,G as Ne,H as qe,I as Re,P as re,J as Ue}from"./index-14b8a3d0.js";class Q{constructor(n){j(this,"conversation");j(this,"avatarHashTag");this.conversation=n}get channel(){return this.conversation.channel}get channelInfo(){return this.conversation.channelInfo}get unread(){return this.conversation.unread}get timestamp(){return this.conversation.timestamp}set timestamp(n){this.conversation.timestamp=n}get timestampString(){return Pe(this.timestamp*1e3,!0)}get lastMessage(){return this.conversation.lastMessage}set lastMessage(n){this.conversation.lastMessage=n}get isMentionMe(){return this.conversation.isMentionMe}get remoteExtra(){return this.conversation.remoteExtra}set isMentionMe(n){this.conversation.isMentionMe=n}get reminders(){return this.conversation.reminders}get simpleReminders(){return this.conversation.simpleReminders}reloadIsMentionMe(){return this.conversation.reloadIsMentionMe()}get extra(){return this.conversation.extra||(this.conversation.extra={}),this.conversation.extra}isEqual(n){return this.conversation.isEqual(n.conversation)}}function Pe(l,n){var s=new Date,i=new Date(l),I=s.getFullYear(),$=s.getMonth()+1,L=s.getDate(),D=i.getFullYear(),p=i.getMonth()+1,h=i.getDate(),f="",C=n?" "+H(i,"hh:mm"):"";if(I===D){var T=s.getTime(),r=l,u=T-r;if($===p&&L===h)u<60*1e3?f="刚刚":f=H(i,"hh:mm");else{var a=new Date;a.setDate(a.getDate()-1);var g=new Date;if(g.setDate(g.getDate()-2),p===a.getMonth()+1&&h===a.getDate())f="昨天"+C;else if(p===g.getMonth()+1&&h===g.getDate())f="前天"+C;else{var y=u/36e5;if(y<=7*24){var v=new Array(7);v[0]="星期日",v[1]="星期一",v[2]="星期二",v[3]="星期三",v[4]="星期四",v[5]="星期五",v[6]="星期六";var x=v[i.getDay()];f=x+C}else f=H(i,"yyyy/M/d")+C}}}else f=H(i,"yyyy/M/d")+C;return f}var H=function(l,n){var s={"M+":l.getMonth()+1,"d+":l.getDate(),"h+":l.getHours(),"m+":l.getMinutes(),"s+":l.getSeconds(),"q+":Math.floor((l.getMonth()+3)/3),S:l.getMilliseconds()};/(y+)/.test(n)&&(n=n.replace(RegExp.$1,(l.getFullYear()+"").substr(4-RegExp.$1.length)));for(var i in s)new RegExp("("+i+")").test(n)&&(n=n.replace(RegExp.$1,RegExp.$1.length===1?s[i]:("00"+s[i]).substr((""+s[i]).length)));return n};const Be={class:"conversations"},Fe=["onClick"],Ae={class:"item-content"},Ke={class:"left"},He={key:0,class:"avatar",style:{width:"48px",height:"48px"}},Ve=["src"],Ge={key:1,class:"avatar",style:{width:"48px",height:"48px"}},ze={class:"right"},Oe={class:"right-item1"},je={class:"title"},Je={class:"time"},Ye={class:"right-item2"},Qe={class:"last-msg"},Xe={key:0,className:"reddot"},Ze=P({__name:"index",props:{onSelectChannel:{type:Function}},setup(l){const n=l,s=m(),i=m(),I=async r=>{if(console.log("connectStatusListener",r),r===de.Connected){const u=await c.shared().conversationManager.sync();u&&u.length>0&&(s.value=h(u.map(a=>new Q(a))))}},$=r=>{console.log("收到CMD：",r);const u=r.content;if(u.cmd===Ie.CMDTypeClearUnread){const a=new G(u.param.channelID,u.param.channelType);p(a)}},L=(r,u)=>{var a,g,y;if(u===A.add)s.value=[new Q(r),...s.value||[]];else if(u===A.update){const v=(a=s.value)==null?void 0:a.findIndex(x=>x.channel.channelID===r.channel.channelID&&x.channel.channelType===r.channel.channelType);v!==void 0&&v>=0&&(s.value[v]=new Q(r),s.value=h())}else if(u===A.remove){const v=(g=s.value)==null?void 0:g.findIndex(x=>x.channel.channelID===r.channel.channelID&&x.channel.channelType===r.channel.channelType);v&&v>=0&&((y=s.value)==null||y.splice(v,1))}},D=r=>{s.value=[...s.value||[]]},p=r=>{const u=c.shared().conversationManager.findConversation(r);u&&(u.unread=0,c.shared().conversationManager.notifyConversationListeners(u,A.update))};le(async()=>{c.shared().connectManager.addConnectStatusListener(I),c.shared().conversationManager.addConversationListener(L),c.shared().chatManager.addCMDListener($),c.shared().channelManager.addListener(D)}),ie(()=>{c.shared().conversationManager.removeConversationListener(L),c.shared().connectManager.removeConnectStatusListener(I),c.shared().chatManager.removeCMDListener($),c.shared().channelManager.removeListener(D)});const h=r=>{let u=r;return u||(u=s.value),!u||u.length<=0?[]:u.sort((g,y)=>{var N,B;let v=g.timestamp,x=y.timestamp;return((N=g.extra)==null?void 0:N.top)===1&&(v+=1e12),((B=y.extra)==null?void 0:B.top)===1&&(x+=1e12),x-v})},f=r=>{i.value=r,n&&n.onSelectChannel(r),U.shared.clearUnread(r),p(r)},C=r=>i.value&&i.value.isEqual(r.channel)?"conversation-item selected":"conversation-item",T=r=>{c.shared().channelManager.getChannelInfo(r)||c.shared().channelManager.fetchChannelInfo(r)};return(r,u)=>(_(),M("div",Be,[(_(!0),M(V,null,ue(s.value,a=>{var g,y,v;return _(),M("div",{class:$e(C(a)),onClick:()=>{f(a.channel)}},[z(S(T(a.channel))+" ",1),e("div",Ae,[e("div",Ke,[a.channel.channelType===w(X)?(_(),M("div",He,[e("img",{src:(g=a.channelInfo)==null?void 0:g.logo,style:{width:"48px",height:"48px"}},null,8,Ve)])):(_(),M("div",Ge,S((y=a.channelInfo)==null?void 0:y.title),1))]),e("div",ze,[e("div",Oe,[e("div",je,S(a.channel.channelID),1),e("div",Je,S(a.timestampString),1)]),e("div",Ye,[e("div",Qe,S((v=a.lastMessage)==null?void 0:v.content.conversationDigest),1),a.unread>0?(_(),M("div",Xe,S(a.unread),1)):E("",!0)])])])],10,Fe)}),256))]))}});const We=O(Ze,[["__scopeId","data-v-eb93adcf"]]),et={class:"text"},tt=P({__name:"Text",props:{message:{}},setup(l){const n=l;return(s,i)=>(_(),M("div",et,S(n.message.content.text),1))}});const st=O(tt,[["__scopeId","data-v-6cae1c31"]]),nt={class:"order"},at={class:"orderNo"},ot={class:"orderMiddle"},rt={class:"orderImg"},ct=["src"],lt={class:"orderMiddleRight"},it={class:"orderTitle"},ut={class:"orderPriceBox"},dt={class:"orderPrice"},ht={class:"orderNum"},vt=P({__name:"CustomMessage",props:{message:{}},setup(l){const s=l.message.content;return(i,I)=>(_(),M("div",nt,[e("div",at,"订单号："+S(w(s).orderNo),1),e("div",ot,[e("div",rt,[e("img",{src:w(s).imgUrl,alt:"",style:{width:"40px",height:"40px"}},null,8,ct)]),e("div",lt,[e("div",it,S(w(s).title),1),e("div",ut,[e("div",dt,"$"+S(w(s).price),1),e("div",ht,"共"+S(w(s).num)+"件",1)])])])]))}});const gt=O(vt,[["__scopeId","data-v-74bf340d"]]),_t=56,ce=P({__name:"Message",props:{message:{}},setup(l){const s=l.message.content.contentType;return(i,I)=>(_(),M("div",null,[w(s)===w(we).text?(_(),te(st,{key:0,message:i.$props.message},null,8,["message"])):E("",!0),w(s)===w(_t)?(_(),te(gt,{key:1,message:i.$props.message},null,8,["message"])):E("",!0)]))}}),he=l=>(Ne("data-v-07bf9fca"),l=l(),qe(),l),pt={class:"chat"},ft={class:"header"},mt=he(()=>e("button",null,"聊天列表",-1)),Mt={class:"center"},Ct={class:"right",style:{display:"flex","align-items":"center"}},xt=he(()=>e("a",{style:{"margin-right":"40px",display:"flex","align-items":"center","font-size":"12px"},href:"https://github.com/WuKongIM/WuKongIM","aria-label":"github",target:"_blank",rel:"noopener","data-v-7bc22406":"","data-v-36371990":""},[e("svg",{role:"img",width:"32px",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("title",null,"GitHub"),e("path",{d:"M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"})]),z("    吴彦祖，点个Star呗 ")],-1)),yt={class:"content"},St={class:"conversation-box"},It={class:"message-box"},$t=["id"],wt={key:0,class:"status"},Dt={class:"bubble right"},kt={class:"avatar"},Tt=["src"],bt=["id"],Lt={class:"avatar"},Et=["src"],Nt={class:"bubble"},qt={class:"footer"},Rt=["placeholder","onKeydown"],Ut={class:"switch"},Pt={class:"item"},Bt=["onClick","checked"],Ft={class:"item"},At=["onClick","checked"],Kt=["placeholder"],Ht=P({__name:"Chat",setup(l){const n=De(),s=m(null),i=m(!1),I=m(""),$=m("");let L=0;const D=m(""),p=m(!0),h=m(new G("",0)),f=m("请输入对方登录名"),C=m(!1),T=m(!1);m(!1);const r=m("请输入消息"),u=m(),a=m(new Array),g=n.currentRoute.value.query.uid||void 0,y=n.currentRoute.value.query.token||"token111";I.value=`${g||""}(未连接)`;let v,x,N;le(()=>{(!U.shared.config.apiURL||U.shared.config.apiURL==="")&&(c.shared().connectManager.disconnect(),n.push({path:"/"})),U.shared.get("/route",{param:{uid:n.currentRoute.value.query.uid}}).then(t=>{console.log(t);let d=t.wss_addr;(!d||d==="")&&(d=t.ws_addr),B(d)}).catch(t=>{console.log(t)})});const B=t=>{const d=c.shared().config;g&&y&&(d.uid=g,d.token=y),d.addr=t,d.sendCountOfEach=1e5,c.shared().config=d,v=(o,k,b)=>{o==de.Connected?b?I.value=`${g||""}(连接成功-节点:${b.nodeId})`:I.value=`${g||""}(连接成功)`:I.value=`${g||""}(断开)`},c.shared().connectManager.addConnectStatusListener(v),x=o=>{if(h.value.isEqual(o.channel)){if(o.streamOn){let k=!1;for(const b of a.value)if(b.streamNo===o.streamNo){let q=b.streams;const R=new Re;R.clientMsgNo=o.clientMsgNo,R.streamSeq=o.streamSeq||0,R.content=o.content,q&&q.length>0?q.push(R):q=[R],b.streams=q,k=!0;break}k||a.value.push(o)}else a.value.push(o);F()}},c.shared().chatManager.addMessageListener(x),N=o=>{console.log(o),a.value.forEach(k=>{if(k.clientSeq==o.clientSeq){k.status=o.reasonCode==1?J.Normal:J.Fail;return}})},c.shared().chatManager.addMessageStatusListener(N),c.shared().connect()};ie(()=>{c.shared().connectManager.removeConnectStatusListener(v),c.shared().chatManager.removeMessageListener(x),c.shared().chatManager.removeMessageStatusListener(N),c.shared().disconnect()});const ve=t=>{p.value=t.target.checked,p.value?f.value="请输入对方登录名":f.value="请输入群组ID"},ge=t=>{p.value=!t.target.checked,p.value?f.value="请输入对方登录名":f.value="请输入群组ID"},F=()=>{const t=s.value;t&&oe(function(){t.scrollTop=t.scrollHeight})},Z=async()=>{C.value=!0,T.value=!1;const t=await c.shared().chatManager.syncMessages(h.value,{limit:15,startMessageSeq:0,endMessageSeq:0,pullMode:re.Up});C.value=!1,t&&t.length>0&&t.forEach(d=>{a.value.push(d)}),F()},_e=async()=>{if(a.value.length==0)return;const t=a.value[0];if(t.messageSeq==1){T.value=!0;return}const d=15,o=await c.shared().chatManager.syncMessages(h.value,{limit:d,startMessageSeq:t.messageSeq-1,endMessageSeq:0,pullMode:re.Down});o.length<d&&(T.value=!0),o&&o.length>0&&o.reverse().forEach(k=>{a.value.unshift(k)}),oe(function(){const k=s.value,b=document.getElementById(t.clientMsgNo);b&&(k.scrollTop=b.offsetTop)})},W=()=>{i.value=!i.value},pe=()=>{p.value?h.value=new G(D.value,X):h.value=new G(D.value,se),p.value||U.shared.joinChannel(h.value.channelID,h.value.channelType,c.shared().config.uid||""),c.shared().conversationManager.findConversation(h.value)||c.shared().conversationManager.createEmptyConversation(h.value),i.value=!1,a.value=[],Z()},fe=t=>{h.value=t,D.value=t.channelID,p.value=t.channelType==X,i.value=!1,a.value=[],Z()},ee=()=>{(!$.value||$.value.trim()==="")&&(L++,$.value=`${L}`);const t=Le.fromUint8(0);if(h.value&&h.value.channelID!=""){var d;u.value&&u.value!==""&&(t.streamNo=u.value),d=new Ee($.value),c.shared().chatManager.send(d,h.value,t),$.value=""}else i.value=!0;F()},me=()=>{if(!h.value||h.value.channelID.trim()==""){i.value=!0;return}const t=new Ue,d=new Date().getTime();t.orderNo=`${d.toString()}`,t.title="可可柠檬鲜美奶茶",t.num=1,t.price=18,t.imgUrl="https://img1.baidu.com/it/u=3855634790,2542680254&fm=253&fmt=auto&app=138&f=JPEG?w=750&h=496",c.shared().chatManager.send(t,h.value),F()},Me=()=>{c.shared().connectManager.disconnect(),n.push({path:"/"})},Ce=t=>{const d=t.target.scrollTop;if(t.target.scrollHeight-(d+t.target.clientHeight),d<=250){if(C.value||T.value){console.log("不允许下拉","pulldowning",C.value,"pulldownFinished",T.value);return}console.log("下拉"),C.value=!0,_e().then(()=>{C.value=!1}).catch(()=>{C.value=!1})}},xe=()=>{ee()};return(t,d)=>(_(),M(V,null,[e("div",pt,[e("div",ft,[e("div",{class:"left"},[e("button",{onClick:Me},"退出"),mt]),e("div",Mt,S(I.value),1),e("div",Ct,[xt,e("button",{onClick:W},S(h.value.channelID.length==0?"与谁会话？":`${h.value.channelType==w(se)?"群":"单聊"}${h.value.channelID}`),1)])]),e("div",yt,[e("div",St,[K(We,{onSelectChannel:fe})]),e("div",It,[e("div",{class:"message-list",onScroll:Ce,ref_key:"chatRef",ref:s},[(_(!0),M(V,null,ue(a.value,o=>(_(),M(V,null,[o.send?(_(),M("div",{key:0,class:"message right",id:o.clientMsgNo},[o.status!=w(J).Normal?(_(),M("div",wt,"发送中")):E("",!0),e("div",Dt,[K(ce,{message:o},null,8,["message"])]),e("div",kt,[e("img",{src:`https://api.dicebear.com/9.x/adventurer/svg?seed=${o.fromUID}&radius=50&backgroundType=gradientLinear&backgroundColor=ffd5dc`,style:{width:"40px",height:"40px"}},null,8,Tt)])],8,$t)):E("",!0),o.send?E("",!0):(_(),M("div",{key:1,class:"message",id:o.clientMsgNo},[e("div",Lt,[e("img",{src:`https://api.dicebear.com/9.x/adventurer/svg?seed=${o.fromUID}&radius=50&backgroundType=gradientLinear&backgroundColor=ffd5dc`,style:{width:"40px",height:"40px"}},null,8,Et)]),e("div",Nt,[K(ce,{message:o},null,8,["message"])])],8,bt))],64))),256))],544),e("div",qt,[ne(e("input",{placeholder:r.value,"onUpdate:modelValue":d[0]||(d[0]=o=>$.value=o),style:{height:"40px"},onKeydown:ke(xe,["enter"])},null,40,Rt),[[ae,$.value]]),e("button",{class:"message-custom",onClick:me},"自定义消息"),e("button",{onClick:ee},"发送")])])])]),K(be,{name:"fade"},{default:Te(()=>[i.value?(_(),M("div",{key:0,class:"setting",onClick:W},[e("div",{class:"setting-content",onClick:d[2]||(d[2]=Y(()=>{},["stop"]))},[e("div",Ut,[e("div",Pt,[e("input",{type:"radio",onClick:Y(ve,["stop"]),checked:p.value},null,8,Bt),z("单聊 ")]),e("div",Ft,[e("input",{type:"radio",onClick:Y(ge,["stop"]),checked:!p.value},null,8,At),z("群聊 ")])]),ne(e("input",{placeholder:f.value,class:"to","onUpdate:modelValue":d[1]||(d[1]=o=>D.value=o)},null,8,Kt),[[ae,D.value]]),e("button",{class:"ok",onClick:pe},"确定")])])):E("",!0)]),_:1})],64))}});const zt=O(Ht,[["__scopeId","data-v-07bf9fca"]]);export{zt as default};
